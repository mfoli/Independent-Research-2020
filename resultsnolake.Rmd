install.packages("ggpubr")
library(ggplot2)
library(ggResidpanel)
library(car)
library(emmeans)
library(gridExtra)
library(grid)
library(gtable)
library(ggpubr)

```{r,include=FALSE}
# This chunk clears your environment, if you're like me and it gets messy over there.
rm(list=ls())
```

```{r}

alldat <- read.csv("YearChange_MetricA.csv", header = T)
names(alldat) <- c("lake", "year", "carp_kg_ha", "buffalo_kg_ha", "total_kg_ha", 
                   "prop_carp", "prop_buff", "delta_tsi", "delta_tsi_chla", "delta_chla",
                   "delta_tss", "delta_tn", "delta_tp", "delta_sd", "delta_do", 
                   "delta_turbid", "delta_total_phyto", "delta_total_zoo",
                   "delta_chloro", "delta_cyano")
alldat$year_fac <- as.factor(alldat$year)
alldat$year_cent <- alldat$year - min(alldat$year)

```

#Looking At Change in TSI

```{r}
ot.tsi <-ggplot(data = alldat, aes(x = year, y = delta_tsi, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in TSI over time",
       x = "year",
       y = "TSI")
ot.tsi

summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)
```

# Model change in TSI based on lake, year and species

```{r}
ggplot(data = alldat, aes(x = delta_tsi)) + geom_histogram(binwidth = 1)
summary(alldat$delta_tsi)

tsimod <- lm(delta_tsi ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tsimod)
Anova(tsimod, type = 3)
summary(tsimod)

```

# Analysis
# Look just at year centered, averaging over year and fish harvest

```{r}
emm_lake <- emmeans(tsimod, specs = "year_cent")
emm_lake #These are the estimated delta-tsi for each lake, at the mean values of buffalo and carp harvest

# Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tsimod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in TSI") +
  ggtitle("Estimated change in TSI vs. carp harvest")

tsi.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "TSI")
tsi.carpharvest
  

refgrid_buf <- ref_grid(tsimod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in TSI") +
  ggtitle("Estimated change in TSI vs. buffalo harvest")

tsi.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")

tsi.buffharvest

```

# Plots
# Plot the data
```{r}

tsi.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tsi)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tsi), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "green = buffalo, blue = carp",
       x = "", y = "change in TSI")

ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tsi)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tsi), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in TSI (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in TSI")
tsi.c

  # Plot the model estimates
refgrid_all <- ref_grid(tsimod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)
```

#Interaction Plots
```{r}
tsi.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in TSI",
       color = "carp harvest (kg/ha)")
tsi.i

```

#Heat maps
```{r}

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on TSI from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TSI")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on TSI from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TSI")
```

#Looking at Change in Chlorophyll a (137-241)     
```{r}
ot.chla <-ggplot(data = alldat, aes(x = year, y = delta_chla, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in chla over time (ug/L)",
       x = "year",
       y = "Chlorphyll a (ug/L)")
ot.chla


chlamod <- lm(delta_chla ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(chlamod)
Anova(chlamod, type = 3)
summary(chlamod)

# Analysis

#Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(chlamod, specs = "year_cent")
emm_lake #These are the estimated delta-tsi for each lake, at the mean values of buffalo and carp harvest

#Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(chlamod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in chl a") +
  ggtitle("Estimated change in chl a vs. carp harvest")


chla.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "chl a (ug/L)")
chla.carpharvest
  

refgrid_buf <- ref_grid(chlamod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in chla") +
  ggtitle("Estimated change in chla vs. buffalo harvest")

chla.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
chla.buffharvest

```


# Plots
# Plot the data
```{r}
chla.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_chla)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_chla), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "" , 
       subtitle = "" ,
       x = "" , y = "change in chla")
 chla.c    
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_chla)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_chla), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in chla (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in chla")

  # Plot the model estimates
  
refgrid_all <- ref_grid(chlamod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)
```

#Interaction plots

```{r}
chla.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in chla",
       color = "carp harvest (kg/ha)")
chla.i
```

#Heat Maps
```{r}

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on chla from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in chla")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on chla from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in chla")
```

#Looking at Change in Chlorophyta (243-346)
```{r}
ot.chloro <-ggplot(data = alldat, aes(x = year, y = delta_chloro, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Chlorophyta over time",
       x = "year",
       y = "Chlorophyta (ug/L)")
ot.chloro


chloromod <- lm(delta_chloro ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(chloromod)
Anova(chloromod, type = 3)
summary(chloromod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(chloromod, specs = "year_cent")
emm_lake #These are the estimated delta-Chlorophyta for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(chloromod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in Chlorophyta") +
  ggtitle("Estimated change in Chlorophyta vs. carp harvest")


chloro.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "Chlorophyta (ug/L)")
chloro.carpharvest 

refgrid_buf <- ref_grid(chloromod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in Chlorophyta") +
  ggtitle("Estimated change in Chlorophyta vs. buffalo harvest")

chloro.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
chloro.buffharvest
```


# Plots
# Plot the data
```{r}

chloro.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_chloro)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_chloro), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in Chlorophyta")
chloro.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_chloro)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_chloro), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in Chlorophyta (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in Chlorophyta")
```

#Interaction plots

```{r}
chloro.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in chlorophyta",
       color = "carp harvest (kg/ha)")
chloro.i
```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(chloromod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on Chlorophyta from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Chlorophyta")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on Chlorophyta from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Chlorophyta")
```

#Looking at Change in Cyanophyta (348-452)

```{r}
ot.cyano <-ggplot(data = alldat, aes(x = year, y = delta_cyano, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Cyanophyta over time",
       x = "year",
       y = "Cyanophyta (ug/L)")
ot.cyano



cyanomod <- lm(delta_cyano ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(cyanomod)
Anova(cyanomod, type = 3)
summary(cyanomod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(cyanomod, specs = "year_cent")
emm_lake #These are the estimated delta-Cyanophyta for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(cyanomod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in Cyanophyta") +
  ggtitle("Estimated change in Cyanophyta vs. carp harvest")


cyano.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "carp harvest (kg/ha)",
       y = "Cyanophyta (ug/L)")
cyano.carpharvest

refgrid_buf <- ref_grid(cyanomod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in Cyanophyta") +
  ggtitle("Estimated change in Cyanophyta vs. buffalo harvest")

cyano.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "buffalo harvest (kg/ha)",
       y = "")
cyano.buffharvest
```


# Plots
# Plot the data

```{r}
cyano.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_cyano)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_cyano), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in Cyanophyta")

cyano.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_cyano)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_cyano), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in Cyanophyta (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in Cyanophyta")
```

#Interaction plots

```{r}
cyano.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in cyanophyta",
       color = "carp harvest (kg/ha)")
cyano.i
```

# Plot the model estimates
```{r}
refgrid_all <- ref_grid(cyanomod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on Cyanophyta from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Cyanophyta")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on Cyanophyta from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Cyanophyta")
```

#Looking at change in Secchi Depth (454-559)

```{r}
ot.sd <-ggplot(data = alldat, aes(x = year, y = delta_sd, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Secchi Depth over time",
       x = "year",
       y = "Secchi Depth (m)")
ot.sd


sdmod <- lm(delta_sd ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(sdmod)
Anova(sdmod, type = 3)
summary(sdmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(sdmod, specs = "year_cent")
emm_lake #These are the estimated delta-SD for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(sdmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in SD") +
  ggtitle("Estimated change in SD vs. carp harvest")


sd.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "SD (m)")
sd.carpharvest
  

refgrid_buf <- ref_grid(sdmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in SD") +
  ggtitle("Estimated change in SD vs. buffalo harvest")

sd.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
sd.buffharvest
```

# Plots
# Plot the data

```{r}

sd.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_sd)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_sd), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in SD")
sd.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_sd)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_sd), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in SD (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in SD")
```

#Interaction plots

```{r}
sd.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in SD",
       color = "carp harvest (kg/ha)")
sd.i
```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(sdmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)



ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on SD from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in SD")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on SD from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in SD")
```

#Looking at Changes in Total Nitrogen (561-667)
```{r}
ot.tn <-ggplot(data = alldat, aes(x = year, y = delta_tn, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Total Nitrogen over time",
       x = "year",
       y = "Total Nitrogen (mg/L)")
ot.tn




tnmod <- lm(delta_tn ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tnmod)
Anova(tnmod, type = 3)
summary(tnmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(tnmod, specs = "year_cent")
emm_lake #These are the estimated delta-TN for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tnmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in TN") +
  ggtitle("Estimated change in TN vs. carp harvest")


tn.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "TN (mg/L)")
tn.carpharvest

refgrid_buf <- ref_grid(tnmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in TN") +
  ggtitle("Estimated change in TN vs. buffalo harvest")

tn.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
tn.buffharvest
```


# Plots
# Plot the data

```{r}
tn.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tn)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tn), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in TN")
tn.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tn)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tn), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in TN (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in TN")
```

#Interaction plots

```{r}
tn.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in TN",
       color = "carp harvest (kg/ha)")
tn.i
```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(tnmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

 
       color = "carp harvest (kg/ha)")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on TN from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TN")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on TN from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TN")
```

#Looking at Change in Total Phosphorous (669-773)

```{r}
ot.tp <-ggplot(data = alldat, aes(x = year, y = delta_tp, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Total Phosphorous over time",
       x = "year",
       y = "Total Phosphorous (ug/L)")
ot.tp



tpmod <- lm(delta_tp ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tpmod)
Anova(tpmod, type = 3)
summary(tpmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(tpmod, specs = "year_cent")
emm_lake #These are the estimated delta-TP for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tpmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in TP") +
  ggtitle("Estimated change in TP vs. carp harvest")


tp.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "carp harvest (kg/ha)",
       y = "TP (ug/L)")
tp.carpharvest
  

refgrid_buf <- ref_grid(tpmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in TP") +
  ggtitle("Estimated change in TP vs. buffalo harvest")

tp.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "buffalo harvest (kg/ha)",
       y = "")
tp.buffharvest
```


# Plots
# Plot the data

```{r}

tp.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tp)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tp), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in TP")
tp.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tp)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tp), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in TP (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in TP")
```

#Interaction plots

```{r}
tp.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in TP",
       color = "carp harvest (kg/ha)")
tp.i

```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(tpmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)


ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on TP from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TP")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on TP from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TP")
```

#Looking at Change in Total Suspended Solids (775-878)

```{r}
ot.tss <-ggplot(data = alldat, aes(x = year, y = delta_tss, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Total Suspended Solids over time",
       x = "year",
       y = "Total Suspended Solids (mg/L)")
ot.tss




tssmod <- lm(delta_tss ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tssmod)
Anova(tssmod, type = 3)
summary(tssmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(tssmod, specs = "year_cent")
emm_lake #These are the estimated delta-TSS for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tssmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in TSS") +
  ggtitle("Estimated change in TSS vs. carp harvest")


tss.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "TSS (mg/L)")
tss.carpharvest

  

refgrid_buf <- ref_grid(tssmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in TSS") +
  ggtitle("Estimated change in TSS vs. buffalo harvest")

tss.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
tss.buffharvest
```



# Plots
# Plot the data

```{r}
tss.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tss)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tss), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in TSS")
tss.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_tss)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_tss), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in TSS (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in TSS")
```

#Interaction plots

```{r}
tss.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in TSS",
       color = "carp harvest (kg/ha)")
tss.i
```

# Plot the model estimates
```{r}
refgrid_all <- ref_grid(tssmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on TSS from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TSS")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on TSS from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in TSS")
```

#Looking at Change in Total Phytoplankton (880-985)
```{r}
ot.tpp <-ggplot(data = alldat, aes(x = year, y = delta_total_phyto, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Total Phytoplankton Biomass over time",
       x = "year",
       y = "Total Phytoplankton Biomass (ug/L)")
ot.tpp


tppmod <- lm(delta_total_phyto ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tppmod)
Anova(tppmod, type = 3)
summary(tppmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(tppmod, specs = "year_cent")
emm_lake #These are the estimated delta-Total Phytoplankton for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tppmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in Total Phytoplankton") +
  ggtitle("Estimated change in Total Phytoplankton vs. carp harvest")


tpp.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "Total Phytoplankton (ug/L)")
tpp.carpharvest

refgrid_buf <- ref_grid(tppmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in Total Phytoplankton") +
  ggtitle("Estimated change in Total Phytoplankton vs. buffalo harvest")

tpp.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
tpp.buffharvest
```


# Plots
# Plot the data

```{r}

tpp.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_total_phyto)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_total_phyto), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in Total Phytoplankton")
tpp.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_total_phyto)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_total_phyto), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in Total Phytoplankton (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in Total Phytoplankton")
```

#Interaction plots

```{r}
tpp.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in Total Phytoplankton",
       color = "carp harvest (kg/ha)")
tpp.i
```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(tppmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)



ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on Total Phytoplankton from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Total Phytoplankton")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on Total Phytoplankton from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Total Phytoplankton")
```

#Looking at Change in Total Zooplankton (987-1090)

```{r}
ot.tzp <-ggplot(data = alldat, aes(x = year, y = delta_total_zoo, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Total Zooplankton Biomass over time",
       x = "year",
       y = "Total Zooplankton Biomass (ug/L)")
ot.tzp



tzpmod <- lm(delta_total_zoo ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(tzpmod)
Anova(tzpmod, type = 3)
summary(tzpmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(tzpmod, specs = "year_cent")
emm_lake #These are the estimated delta-Total Zooplankton for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(tzpmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in Total Zooplankton") +
  ggtitle("Estimated change in Total Zooplankton vs. carp harvest")


tzp.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "Total Zooplankton (ug/L)")
tzp.carpharvest

refgrid_buf <- ref_grid(tzpmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in Total Zooplankton") +
  ggtitle("Estimated change in Total Zooplankton vs. buffalo harvest")

tzp.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "",
       y = "")
tzp.buffharvest
```


# Plots
# Plot the data

```{r}
tzp.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_total_zoo)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_total_zoo), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in Total Zooplankton")
tzp.c
ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_total_zoo)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_total_zoo), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in Total Zooplankton (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in Total Zooplankton")
```

#Interaction plots

```{r}
tzp.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in Total Zooplankton",
       color = "carp harvest (kg/ha)")
tzp.i
```
 
# Plot the model estimates

```{r}
refgrid_all <- ref_grid(tzpmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on Total Zooplankton from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Total Zooplankton")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on Total Zooplankton from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Total Zooplankton")
```

#Looking at Change in Turbidity (1092-1195)

```{r}
ot.turb <-ggplot(data = alldat, aes(x = year, y = delta_turbid, )) + geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "Change in Turbidity over time",
       x = "year",
       y = "Turbidity (NTU)")
ot.turb

turbmod <- lm(delta_turbid ~ year_cent + buffalo_kg_ha * carp_kg_ha, data = alldat)
resid_panel(turbmod)
Anova(turbmod, type = 3)
summary(turbmod)

# Analysis

  # Look just at lakes, averaging over year and fish harvest
emm_lake <- emmeans(turbmod, specs = "year_cent")
emm_lake #These are the estimated delta-Turbidity for each lake, at the mean values of buffalo and carp harvest

  # Look just at sp harvest per lake, averaging over year and other sp harvest
summary(alldat$carp_kg_ha)
summary(alldat$buffalo_kg_ha)

refgrid_carp <- ref_grid(turbmod,
                 at = list(carp_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))
carp_df <- as.data.frame(summary(refgrid_carp, infer = c(T,T)))
head(carp_df)

ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_line() +
  xlab("carp harvest (kg/ha)") + ylab("change in Turbidity") +
  ggtitle("Estimated change in Turbidity vs. carp harvest")


turb.carpharvest <-ggplot(data = carp_df, aes(x = carp_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "carp harvest (kg/ha)",
       y = "Turbidity (NTU)")
turb.carpharvest
  

refgrid_buf <- ref_grid(turbmod, 
                         at = list(buffalo_kg_ha = c(1, 7, 20, 35, 50, 100, 150)))

buff_df <- as.data.frame(summary(refgrid_buf, infer = c(T,T)))
head(buff_df)

ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + geom_line() +
  xlab("buffalo harvest (kg/ha)") + ylab("change in Turbidity") +
  ggtitle("Estimated change in Turbidity vs. buffalo harvest")

turb.buffharvest <-ggplot(data = buff_df, aes(x = buffalo_kg_ha, y = prediction)) + 
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL),alpha=0.2) +
  geom_line() +
  labs(title = "",
       subtitle = "", 
       x = "buffalo harvest (kg/ha)",
       y = "")
turb.buffhavest
```


# Plots
# Plot the data

```{r}
turb.c <-ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_turbid)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_turbid), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "", 
       subtitle = "",
       x = "", y = "change in Turbidity")

ggplot(data = alldat, aes(x = buffalo_kg_ha, y = delta_turbid)) +
  geom_line(color = "darkgreen") +
  geom_line(aes(x = carp_kg_ha, y = delta_turbid), color = "darkblue") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap( ~ lake) +
  labs(title = "Harvest vs. Change in Turbidity (data values averaged over all years)", 
       subtitle = "green = buffalo, blue = carp",
       x = "harvest (kg/ha)", y = "change in Turbidity")
turb.c
```

#Interaction plots

```{r}
turb.i <-emmip(refgrid_all, carp_kg_ha ~ buffalo_kg_ha, CIs = T) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title = "",
       subtitle = "",
       x = "",
       y = "estimated change in Turbidity",
       color = "carp harvest (kg/ha)")
turb.i
```

# Plot the model estimates

```{r}
refgrid_all <- ref_grid(turbmod, cov.keep = "lake",
                        at = list(buffalo_kg_ha = seq(0,150, by = 25), 
                                  carp_kg_ha = seq(0,150, by = 25)))


model_df <- as.data.frame(summary(refgrid_all, infer = c(T,T)))
head(model_df)

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  labs(title = "Modeled effect on Turbidity from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Turbidity")

ggplot(model_df,
       aes(x = as.factor(buffalo_kg_ha), y = as.factor(carp_kg_ha), fill = prediction)) +
  geom_tile() +
  scale_fill_gradient2(low="darkblue", mid="grey50", high="brown", midpoint=0) +
  facet_wrap(~lake) +
  labs(title = "Modeled effect on Turbidity from fish harvest",
       x = "buffalo harvest (kg/ha)",
       y = "carp harvest (kg/ha)",
       fill = "Change in Turbidity")
```   
       
#Combined Figures For Average Change of Value for Buffalo and Carp Density
#Starting with Nutrients and TSI
```{r}
#Nutrients + TS
#pulls legend from plot


Nharvest <-grid.arrange(tsi.carpharvest + theme(legend.position = "none"), tsi.buffharvest + theme(legend.position = "none"),
                        chla.carpharvest + theme(legend.position = "none"), chla.buffharvest + theme(legend.position = "none"),
                        tn.carpharvest + theme(legend.position = "none"), tn.buffharvest + theme(legend.position = "none"),
                        tp.carpharvest + theme(legend.position = "none"), tp.buffharvest+ theme(legend.position = "none"), ncol=2)

Nharvest


#Biomass
grid.arrange(tpp.carpharvest + theme(legend.position = "none"), tpp.buffharvest + theme(legend.position = "none"), tzp.carpharvest + theme(legend.position = "none"), tzp.buffharvest + theme(legend.position = "none"), chloro.carpharvest + theme(legend.position = "none"), chloro.buffharvest + theme(legend.position = "none"), cyano.carpharvest + theme(legend.position = "none"), cyano.buffharvest + theme(legend.position = "none"), ncol=2)

#Physical
grid.arrange(sd.carpharvest + theme(legend.position = "none"), sd.buffharvest + theme(legend.position = "none"), tss.carpharvest + theme(legend.position = "none"), tss.buffharvest + theme(legend.position = "none"), turb.carpharvest + theme(legend.position = "none"), turb.buffharvest + theme(legend.position = "none"), ncol=2)
```      

#Combining change in variable due to harvest plots

```{r}
cplot <-grid.arrange(tsi.c, chla.c, tn.c, tp.c, tpp.c, tzp.c, chloro.c, cyano.c, sd.c, tss.c, turb.c, ncol =2)
annotate_figure(cplot, top = text_grob("Change in Variable vs Harvest", color = "black", face = "bold"), bottom = text_grob("Harvest (Kg/HA)"))
cplot
```

```{r}
overtime <-grid.arrange(ot.tsi, ot.chla, ot.tn, ot.tp, ot.tpp, ot.tzp, ot.chloro, ot.cyano, ot.sd, ot.tss, ot.turb, ncol=2)
annotate_figure(ovetime, top = text_grob("Change in Response Variable over Time", color = "black", face = "bold"))
overtime
```

#Combining Interaction Plots for Each Variable
```{r}
#create universal legend
i_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

ilegend<-i_legend(tsi.i)
#create plot for tsi and nutrients
iplotn <-grid.arrange(tsi.i + theme(legend.position = "none"), chla.i + theme(legend.position = "none"), tn.i + theme(legend.position = "none"), tp.i + theme(legend.position = "none"), ncol =2, ilegend)
#annotate
annotate_figure(iplotn, top = text_grob("Interaction plot for each variable", color = "black", face = "bold"), bottom = text_grob("Buffalo Harvest (Kg/HA)"))

#create plot for biological variables
iplotb <-grid.arrange(tpp.i + theme(legend.position = "none"), tzp.i + theme(legend.position = "none"), chloro.i + theme(legend.position = "none"), cyano.i + theme(legend.position = "none"), ncol =2, ilegend)
annotate_figure(iplotb, top = text_grob("Interaction plot for each Biological variable", color = "black", face = "bold"), bottom = text_grob("Buffalo Harvest (Kg/HA)"))

#create plot for physical variables
iplotp <- grid.arrange(sd.i + theme(legend.position = "none"), tss.i + theme(legend.position = "none"), turb.i + theme(legend.position = "none"), ncol =2, ilegend)
annotate_figure(iplotp, top = text_grob("Interaction plot for each Physical variable", color = "black", face = "bold"), bottom = text_grob("Buffalo Harvest (Kg/HA)"))

iplotn
iplotb
iplotp


```
